<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <record model="ir.actions.act_window" id="action_picking_move_line">
        <field name="name">Product Move</field>
        <field name="res_model">stock.move.line</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('move_id.estate_picking_id', '=', active_id)]</field>
    </record>

    <record model="ir.actions.act_window" id="action_picking_move">
        <field name="name">Detailed Operations</field>
        <field name="res_model">stock.move</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('estate_picking_id', '=', active_id)]</field>
    </record>

    <record id="estate_picking_view_tree" model="ir.ui.view">
        <field name="name">estate.picking.view.tree</field>
        <field name="model">estate.picking</field>
        <field name="arch" type="xml">
            <list default_order="scheduled_date desc">
                <field name="name" />
                <field name="partner_id" widget="many2one_avatar_user" />
                <field name="user_id" widget="many2one_avatar_user" />
                <field name="scheduled_date" />
                <field name="date_done" />
                <field name="driver" />
                <field name="vehicle" />
                <field name="company_id" />
                <field name="unload_weight" optional="show" sum="Sum Unload Weight" />
                <field name="additional_weight" optional="hide" />
                <field
                    name="state"
                    widget="badge"
                    decoration-info="state == 'draft'"
                    decoration-danger="state == 'cancel'"
                    decoration-warning="state == 'confirm'"
                    decoration-success="state == 'done'"
                />
            </list>
        </field>
    </record>

    <record id="estate_picking_view_form" model="ir.ui.view">
        <field name="name">estate.picking.view.form</field>
        <field name="model">estate.picking</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button
                        name="action_draft"
                        string="Set to Draft"
                        type="object"
                        class="btn-secondary"
                        invisible="state in ('draft', 'done')"
                    />
                    <button
                        name="action_confirm"
                        string="Confirm"
                        type="object"
                        class="btn-primary"
                        invisible="state != 'draft'"
                    />
                    <button
                        name="action_done"
                        string="Done"
                        type="object"
                        class="btn-primary"
                        invisible="state != 'confirm'"
                    />
                    <button
                        name="action_update_unload"
                        string="Update Unload"
                        type="object"
                        invisible="state == 'done'"
                        class="btn-secondary"
                    />
                    <field
                        name="state"
                        widget="statusbar"
                        statusbar_visible="draft,confirm,done"
                    />
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button
                            name="%(action_picking_move)d"
                            type="action"
                            class="oe_stat_button"
                            icon="oi-arrows-v"
                        >
                            <div class="o_stat_info">
                                <span class="o_stat_text">Detailed Operations</span>
                            </div>
                        </button>
                        <button
                            name="%(action_picking_move_line)d"
                            type="action"
                            class="oe_stat_button"
                            icon="fa-bars"
                        >
                            <div class="o_stat_info">
                                <span class="o_stat_text">Product Move</span>
                            </div>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1 class="d-flex">
                            <field name="priority" widget="priority" class="me-3" />
                            <field name="name" force_save="1" />
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="company_id" invisible="1" />
                            <field name="partner_id" readonly="state != 'draft'" />
                            <field name="driver" />
                            <field name="vehicle" />
                            <field name="exclude_from_bjr" />
                        </group>
                        <group>
                            <field
                                name="scheduled_date"
                                invisible="state == 'done'"
                                readonly="state != 'draft'"
                            />
                            <field
                                name="date_done"
                                invisible="state != 'done'"
                                readonly="1"
                            />
                            <field name="origin" />

                        </group>
                    </group>
                    <notebook>
                        <page name="harvest" string="Harvest Ticket">
                            <field
                                name="total_harvest_qty"
                                string="Harvest Qty"
                                invisible="1"
                            />
                            <field
                                name="total_harvest_stock"
                                string="Harvest Stock"
                                invisible="1"
                            />
                            <field
                                name="total_other_harvest_qty"
                                string="Harvest Qty"
                                invisible="1"
                            />
                            <field
                                name="total_other_harvest_stock"
                                string="Harvest Stock"
                                invisible="1"
                            />
                            <field
                                name="harvest_ids"
                                widget="harvest_picking_widget"
                                domain="[
                                        ('picking_id', '=', False),
                                        ('company_id', '=', company_id),
                                    ]"
                                options="{'reload_on_button': True}"
                                force_save="1"
                                readonly="state != 'draft'"
                            >
                                <list>
                                    <field name="name" />
                                    <field name="operation_date" />
                                    <field name="block_id" />
                                    <field name="member_id" optional="hide" />
                                    <field name="harvest_main_product_id" />
                                    <field
                                        name="harvest_qty_weight"
                                        sum="Sum of Harvest Qty Weight"
                                        options="{'human_readable':true}"
                                    />
                                    <field
                                        name="harvest_other_product_id"
                                        optional="hide"
                                    />
                                    <field
                                        name="other_harvest_stock_qty"
                                        optional="hide"
                                        sum="Sum of Other Harvest Qty Weight"
                                        options="{'human_readable':true}"
                                    />
                                    <button
                                        name="action_view_activity_hrvs"
                                        type="object"
                                        icon="fa-external-link"
                                        class="oe_edit_only text-success"
                                        title="Open Harvest Form"
                                    />
                                </list>
                            </field>
                            <group>
                                <group class="oe_subtotal_footer oe_right" colspan="2">
                                    <field
                                        name="additional_weight"
                                        readonly="1"
                                        force_save="1"
                                    />
                                    <field
                                        name="unload_weight"
                                        readonly="1"
                                        force_save="1"
                                    />
                                </group>
                            </group>

                        </page>
                        <page
                            string="Operations"
                            name="operations"
                            groups="base.group_no_one"
                        >
                            <field name="move_ids" mode="list,kanban">
                                <list
                                    decoration-muted="scrapped == True or state == 'cancel' or (state == 'done' and is_locked == True)"
                                    editable="bottom"
                                    create="0"
                                >
                                    <field name="company_id" column_invisible="True" />
                                    <field name="name" column_invisible="True" />
                                    <field
                                        name="state"
                                        readonly="0"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="move_line_ids"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="location_id"
                                        column_invisible="False"
                                    />
                                    <field
                                        name="location_dest_id"
                                        column_invisible="False"
                                    />
                                    <field
                                        name="partner_id"
                                        column_invisible="True"
                                        readonly="state == 'done'"
                                    />
                                    <field name="scrapped" column_invisible="True" />
<!--                                    <field-->
<!--                                        name="product_type"-->
<!--                                        column_invisible="True"-->
<!--                                    />-->
                                    <field
                                        name="show_details_visible"
                                        column_invisible="True"
                                    />
<!--                                    <field-->
<!--                                        name="show_reserved"-->
<!--                                        column_invisible="True"-->
<!--                                    />-->
                                    <field name="additional" column_invisible="True" />
                                    <field
                                        name="move_lines_count"
                                        column_invisible="True"
                                    />
                                    <field name="is_locked" column_invisible="True" />
                                    <field
                                        name="product_uom_category_id"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="has_tracking"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="display_assign_serial"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="product_id"
                                        context="{'default_detailed_type': 'product'}"
                                        required="1"
                                        readonly="1"
                                        force_save="1"
                                    />
                                    <field
                                        name="description_picking"
                                        string="Description"
                                        optional="hide"
                                    />
                                    <field name="date" optional="hide" />
                                    <field name="date_deadline" optional="hide" />
                                    <field
                                        name="is_quantity_done_editable"
                                        column_invisible="True"
                                    />
                                    <field name="show_quant" column_invisible="True" />
                                    <field
                                        name="display_assign_serial"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="is_initial_demand_editable"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="display_import_lot"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="picking_type_entire_packs"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="product_packaging_id"
                                        groups="product.group_stock_packaging"
                                        context="{'default_product_id': product_id}"
                                        readonly="not product_id"
                                    />
                                    <field
                                        name="product_uom_qty"
                                        string="Demand"
                                        readonly="1"
                                        force_save="1"
                                    />
                                    <field
                                        name="forecast_expected_date"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="forecast_availability"
                                        string="Forecast"
                                        optional="hide"
                                        widget="forecast_widget"
                                    />
                                    <field
                                        name="product_qty"
                                        readonly="1"
                                        column_invisible="True"
                                    />
                                    <field
                                        name="quantity"
                                        string="Quantity"
                                        readonly="not is_quantity_done_editable"
                                        column_invisible="parent.state=='draft'"
                                        decoration-danger="product_uom_qty and quantity &gt; product_uom_qty and parent.state not in ['done', 'cancel']"
                                    />
                                    <field
                                        name="product_uom"
                                        readonly="state != 'draft' and not additional"
                                        options="{'no_open': True, 'no_create': True}"
                                        string="Unit"
                                        groups="uom.group_uom"
                                    />
                                    <field
                                        name="product_uom"
                                        groups="!uom.group_uom"
                                        column_invisible="True"
                                    />
                                </list>
                            </field>
                            <field name="id" invisible="1" />
                        </page>
                        <page name="information" string="Additional Information">
                            <group>
                                <group string="Other Information">
                                    <field name="user_id" readonly="state != 'draft'" />
                                    <field
                                        name="loader_ids"
                                        widget="many2many_tags"
                                        readonly="state != 'draft'"
                                    />
                                    <field name="estate_ids" widget="many2many_tags" />
                                    <field
                                        name="company_id"
                                        groups="base.group_multi_company"
                                        readonly="state != 'draft'"
                                    />
                                </group>
                                <group string="Vehicle Information">
                                    <field name="gross_weight" />
                                    <field name="tare_weight" />
                                    <field name="net_weight" />
                                </group>
                            </group>
                        </page>
                        <page name="internal_notes" string="Internal Notes">
                            <field name="note" placeholder="Internal Note..." />
                        </page>
                    </notebook>
                </sheet>
                <chatter reload_on_follwers="True"/>
            </form>
        </field>
    </record>

    <record id="estate_picking_view_kanban" model="ir.ui.view">
        <field name="name">estate.picking.view.form</field>
        <field name="model">estate.picking</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" sample="1">
                <field name="name" />
                <field name="partner_id" />
                <field name="state" />
                <field name="scheduled_date" />
                <field name="activity_state" />
                <progressbar
                    field="activity_state"
                    colors='{"planned": "success", "overdue": "danger", "today": "warning"}'
                />
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_record_top mb8">
                                <div class="o_kanban_record_headings ms-1">
                                    <strong class="o_kanban_record_title"><span><t
                                                t-esc="record.name.value"
                                            /></span></strong>
                                </div>
                                <strong>
                                        <field
                                        name="state"
                                        widget="label_selection"
                                        options="{'classes': {'draft': 'default', 'cancel': 'danger', 'confirm': 'warning', 'done': 'success', 'locked': 'success'}}"
                                    />
                                </strong>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <t t-esc="record.partner_id.value" />
                                    <field
                                        name="activity_ids"
                                        widget="kanban_activity"
                                    />
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <t
                                        t-esc="record.scheduled_date.value and record.scheduled_date.value.split(' ')[0] or False"
                                    />
                                    <field
                                        name="user_id"
                                        widget="many2one_avatar_user"
                                        invisible="not user_id"
                                        readonly="state in ['cancel', 'done', 'locked']"
                                    />
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="estate_picking_view_search" model="ir.ui.view">
        <field name="name">estate.picking.view.search</field>
        <field name="model">estate.picking</field>
        <field name="arch" type="xml">
            <search string="Picking">
                <field name="name" />
                <field
                    name="estate_ids"
                    filter_domain="['|', ('estate_ids.name', 'ilike', self), ('estate_ids.code','ilike',self)]"
                />
                <filter
                    name="filter_draft"
                    string="Draft"
                    domain="[('state', '=', 'draft')]"
                />
                <filter
                    name="filter_confirm"
                    string="Confirmed"
                    domain="[('state', '=', 'confirm')]"
                />
                <filter
                    name="filter_done"
                    string="Done"
                    domain="[('state', '=', 'done')]"
                />
                <filter
                    name="filter_locked"
                    string="Locked"
                    domain="[('state', '=', 'locked')]"
                />
                <filter
                    name="filter_cancel"
                    string="Cancelled"
                    domain="[('state', '=', 'cancel')]"
                />
                <separator />
                <filter
                    name="filter_scheduled_date"
                    string="Scheduled Date"
                    date="scheduled_date"
                />
                <group expand="1" string="Group By">
                    <filter
                        string="Partner"
                        name="group_partner_id"
                        domain="[]"
                        context="{'group_by': 'partner_id'}"
                    />
                    <filter
                        string="Estate"
                        name="group_estate_ids"
                        domain="[]"
                        context="{'group_by': 'estate_ids'}"
                    />
                </group>
            </search>
        </field>
    </record>

    <record id="estate_picking_action_view" model="ir.actions.act_window">
        <field name="name">Picking</field>
        <field name="res_model">estate.picking</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="estate_picking_view_search" />
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new picking operation.
            </p>
        </field>
    </record>
</odoo>
